#! /usr/bin/env gforth
\                                           -*- forth -*-

vocabulary dmgforth
vocabulary dmgforth-user

get-current
also dmgforth definitions
constant previous-wid

also dmgforth

require ./src/rom.fs
require ./src/asm.fs

also gb-assembler-impl
' rom, IS emit
' rom-offset IS offset
' rom! IS emit-to
previous

rom erase

include ./src/cartridge.fs

( command line arguments processing )

( Add lib/ to the search path of the game )
s" DMGFORTH_PATH" getenv 2constant dmgforth-path
fpath clear-path
dmgforth-path fpath also-path
fpath path+ ./

: usage
  ." Usage: dmgforth <input> <output>" cr
  1 (bye) ;

argc @ 3 <> [if]
  ' usage stderr outfile-execute
[then]

next-arg 2constant input-file
next-arg 2constant output-file

require ./src/user.fs

( We want to load the input file sealed in the DMGFORTH-USER
( vocabulary. The problem is that we do not want to populate this
  vocabulary with auxiliary words to load the input-file.

  Instead, we put all the words in this colon-definition to resolve
  the word into addresses before we seal and load the game.
)
:noname
  get-order

  [user-definitions]
  seal also
  input-file included
  [end-user-definitions]

  set-order
; execute

depth 0<> [if]
  ." The stac2k is not empty!" cr
[endif]

fix-header-complement
fix-global-checksum
output-file dump-rom
bye
